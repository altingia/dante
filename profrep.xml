<tool id="profrep" name="ProfRep" version="1.0.0">
<description> Tool to identify and visualize general repetive profile of a sequence as well as assign repetitive regions to a class from database of repeats </description>
<command>
export JBROWSE_BIN="/home/galaxy/bin/JBrowse-1.12.1/bin";
/mnt/raid/opt/python-3.4.4/bin/python3 /mnt/raid/users/galaxy/galaxy-dist2/tools/profrep/profrep_pd.py --query ${input} --identical ${identical}  
--align_length ${align_length} --word_size ${word_size} --e_value ${e_value} --threshold ${threshold} --window ${window} 
--overlap ${overlap} --output ${ProfTbl} --output_gff ${ProfGff} --html_file ${html_file}
--html_path ${html_file.extra_files_path} --n_gff ${NGff}
--protein_database /mnt/raid/users/galaxy/galaxy-dist2/tool-data/protein_domains_data/proteins_all
--classification /mnt/raid/users/galaxy/galaxy-dist2/tool-data/protein_domains_data/classification.csv
--domain_gff ${DomGff}

 #if $custom_data.options_custom_data:
	--database ${reads}
    --annotation_tbl ${annotations}
    --cls ${cls}
	--new_db True
	#if $custom_data.cn.copy_num:
    --coverage ${custom_data.cn.genome_size}
    #end if
 #else
	--database /mnt/raid/users/galaxy/galaxy-dist2/tool-data/profrep_data/$custom_data.prepared_dataset*reads_all
    --annotation_tbl /mnt/raid/users/galaxy/galaxy-dist2/tool-data/profrep_data/$custom_data.prepared_dataset*annotation
    --cls /mnt/raid/users/galaxy/galaxy-dist2/tool-data/profrep_data/$custom_data.prepared_dataset*.cls
    --db_name '${custom_data.prepared_dataset.fields.name}'
    --reference '${custom_data.prepared_dataset.fields.reference}'
     #if $custom_data.copy_numbers:
        --coverage ${custom_data.prepared_dataset.fields.coverage}
    #end if
 #end if
 >> $log_file 
</command> 

<inputs>
 <param format="fasta" type="data" name="input" label="Choose your input sequence" help="Input sequence must be in proper fasta format, multi-fasta allowed" />
 <conditional name="custom_data" >
  <param name="options_custom_data" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Use custom annotation data" />
  <when value="false">
   <param name="prepared_dataset" type="select" label="Choose existing annotation dataset" >
    <options from_file="prepared_datasets.txt" >
     <column name="name" index="1"/>
     <column name="value" index="0" />
     <column name="coverage" index="2"/>
     <column name="reference" index="3"/>
    </options>
   </param>  
   <param name="copy_numbers" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Convert hits to copy numbers"  />  
  </when>
  <when value="true">
   <param format="fasta" type="data" name="reads" label="Choose file of all reads" help="File containing reads sequences in fasta format" />
   <param format="tabular" type="data" name="annotations" label="Choose clusters annotation file" />
   <param format="cls" type="data" name="cls" label="Choose cls file" />
   <conditional name="cn">
    <param name="copy_num" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Convert hits to copy numbers" />
    <when value="true">
     <param name="genome_size" type="float" value="0" min="0.0000001" max ="1000000" label="Enter the genome size (Mbp)" />
    </when>
   </conditional>
  </when>
 </conditional>

 <param name="identical" type="integer" value="95" label="Minimal % identical" help="Blast filtering option: sequence indentity threshold between query and mapped read from db" />
 <param name="align_length" type="integer" value="40" label="Minimal alignment length" help="Blast filtering option: minimal alignment length threshold in bp" />
 <param name="e_value" type="text" value="1e-15" label="e-value cut-off" help="Blast filtering option: statistical significance threshold for reporting hits" />
 <param name="word_size" type="integer" value="11" min="7" max="20" label="Initial word size" help="Initial word size used by blast for alignment" />  
 <param name="window" type="integer" value="5000" min="5000" label="Window size" help="Use when having a long input sequence so that it can be processed parallely" />
 <param name="overlap" type="integer" value="150" min="150" max="500" label="Windows overlap" help="Must be greater than read length" />
 <param name="threshold" type="integer" value="10" min="1" label="Threshold" help="Threshold for copy numbers at certain position to be reported as a repeat in GFF format"  />

</inputs>

 <outputs>
 	<data format="csv" name="ProfTbl" label="Repetitive profile table from dataset ${input.hid}" />
	<data format="gff3" name="ProfGff" label="GFF file of repetitive regions from dataset ${input.hid}" />
	<data format="gff3" name="DomGff" label="GFF file of protein domains from dataset ${input.hid}" />
	<data format="html" name="html_file" label="HTML output, JBrowse visualization ${input.hid}" />
	<data format="gff3" name="NGff" label="GFF file of unknown bases(N) from dataset ${input.hid}" />
	<data format="txt" name="log_file" label="Log file" />

 </outputs>

 <help>

**What it does**

This tool uses former outputs from Repeat Explorer to create repetitive profile of a sequence and assigns reported regions to known repetition classes. As result the table containg all hits for all classes, repetitive profile picture and GFF3 format of regions are produced.
Using window parameter can speed up the analysis in case of having large input data.
 </help>

 
</tool>

