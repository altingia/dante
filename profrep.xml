<tool id="profrep" name="ProfRep" version="1.0.0">
<description> Tool to identify and visualize general repetive profile of a sequence as well as assign repetitive regions to a class from database of repeats </description>
<requirements>
    <requirement type="package" version="1.0.0" >profrep</requirement>
</requirements>
<command>
python3 ${__tool_directory__}/profrep_pd.py --query ${input} --output ${ProfTbl} --output_gff ${ProfGff} --html_file ${html_file}
--html_path ${html_file.extra_files_path} --n_gff ${NGff} 
--protein_database ${__tool_data_path__ }/protein_domains
--classification ${__tool_data_path__ }/protein_domains
--galaxy_usage True
--tool_dir ${__tool_data_path__ }/profrep
--protein_domains $domains_switch
--jbrowse_bin \${JBROWSE_BIN}

 #if $domains_switch:
	--domain_gff ${DomGff}
 #end if

 #if $advanced_options.opts:
	--identical ${advanced_options.identical}  
	--align_length ${advanced_options.align_length} 
	--word_size ${advanced_options.word_size} 
	--e_value ${advanced_options.e_value} 
	--threshold ${advanced_options.threshold} 
	--window ${advanced_options.window} 
	--overlap ${advanced_options.overlap} 
	#if $advanced_options.dust_filter:
		--dust_filter "yes"
	#else
		--dust_filter "no"
	#end if
 #end if
 
 #if $custom_data.options_custom_data:
    --database ${reads}
    --annotation_tbl ${annotations}
    --cls ${cls}
    --new_db True
	#if $custom_data.cn.copy_num:
        --genome_size ${custom_data.cn.genome_size}
    #end if
 #else
    --datasets_tbl prepared_datasets.txt
    --db_id ${custom_data.prepared_dataset}  
    --copy_numbers '$custom_data.copy_numbers'
 #end if 
 > $log_file 
</command> 

<inputs>
 <param format="fasta" type="data" name="input" label="Choose your input sequence" help="Input sequence must be in proper fasta format, multi-fasta allowed" />
 <conditional name="custom_data" >
  <param name="options_custom_data" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Use custom annotation data" />
  <when value="false">
   <param name="prepared_dataset" type="select" label="Choose existing annotation dataset"  help="You can find list of all available species below in the Database section">
    <options from_file="prepared_datasets.txt" >
     <column name="name" index="1"/>
     <column name="value" index="0"/>
    </options>
   </param>  
   <param name="copy_numbers" type="boolean" truevalue="true" falsevalue="" checked="true" label="Convert hits to copy numbers"  />  
  </when>
  <when value="true">
   <param format="fasta" type="data" name="reads" label="Choose file of all reads" help="This file  contains reads sequences in fasta format"  />
   <param format="cls" type="data" name="cls" label="Choose file containing reads assigned to clusters (.cls file of RE clustering output)" help="This file in fasta format contains cluster number as identifier(e.g. >CL100) and belonging reads names as a subsequent line" />
   <param format="tabular" type="data" name="annotations" label="Choose clusters annotation file" help="This file contains number of cluster (1st column) and its  repetitive classification (2nd column)" />
   <conditional name="cn">
    <param name="copy_num" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Convert hits to copy numbers" />
    <when value="true">
     <param name="genome_size" type="float" value="0" min="0.0000001" max ="1000000" label="Enter the genome size in Mbp" />
    </when>
   </conditional>
  </when>
 </conditional>
 <param name="domains_switch" type="boolean" display="checkbox" truevalue="True" falsevalue="False" checked="True" label="Show protein domains"/>
 <conditional name="advanced_options" >
  <param name="opts" type="boolean" display="checkbox" truevalue="true" falsevalue="false" checked="false" label="Advanced options"/>
  <when value="true">
   <param name="identical" type="integer" value="95" label="Minimum % identical" help="Blast filtering option: sequence indentity threshold between query and mapped read from db" />
   <param name="align_length" type="integer" value="40" label="Minimum alignment length" help="Blast filtering option: minimum alignment length threshold in bp" />
   <param name="e_value" type="text" value="1e-15" label="e-value cut-off" help="Blast filtering option: statistical significance threshold for reporting hits" />
   <param name="word_size" type="integer" value="11" min="7" max="20" label="Initial word size" help="Initial word size used by Blast for alignment" />  
   <param name="dust_filter" type="boolean" display="checkbox" truevalue="True" falsevalue="False" checked="True" label="Use DUST filter" help="Filters query sequence for low-complexity regions with DUST filter" >
   </param>
   <param name="window" type="integer" value="5000" min="5000" label="Sliding window size" help="Use when having a long input sequence so that it can be processed in parallel" />
   <param name="overlap" type="integer" value="150" min="150" max="500" label="Windows overlap" help="Must be greater than read length" />
   <param name="threshold" type="integer" value="10" min="1" label="Repetitive threshold" help="Threshold for copy numbers/hits at certain position to be reported as repetitive in GFF format"  />
  </when>
 </conditional>
</inputs>

 <outputs>
 	<data format="csv" name="ProfTbl" label="Repetitive profile table from dataset ${input.hid}" />
	<data format="gff3" name="ProfGff" label="GFF file of repetitive regions from dataset ${input.hid}" />
	<data format="gff3" name="DomGff" label="GFF file of protein domains from dataset ${input.hid}" >
	 <filter>domains_switch</filter>
	</data>
	<data format="html" name="html_file" label="HTML output, JBrowse visualization ${input.hid}" />
	<data format="gff3" name="NGff" label="GFF file of unknown bases(N) from dataset ${input.hid}" />
	<data format="txt" name="log_file" label="Log file" />

 </outputs>

 <help>
	 
**DATABASE OF SPECIES**

List of all species with annotated repeats in hierarchical order available `HERE`__.

.. __: /static/profrep/species_list.html



**WHAT IT DOES**

This tool uses former clustering output (.cls files) from Repeat Explorer (list of all clusters and belonging reads), annotation table that assigns repetitive class to every cluster and list of all sequencing reads to create repetitive profile of a sequence as well as to report protein domains. You can either provide your own files or you can exploit our prepared datasets for certain species listed above. At first Blast+ runs similarity search to find hits in a given sequence from the reads database which are subsequently filtered to gain only that ones which possess high similarity and appropriate lenght. Other parameters of blast search are also adjustable in "Advanced options". Using window parameter can speed up the analysis especially in case of having large input data as it allows paralell processing of the sequence with a certain overlap. When using our annotation datasets copy numbers are reported by default, if you wish to convert hits to copy numbers in your custom annotation data you will be asked to provide genome size of the species so that the sequencing coverage can be calculated. 
Protein domains search utilizes LAST tool to find hits between input sequence and our database of protein domains. LAST aligns the input translated into protein sequence to the known domains sequences, possible frameshifts in the alignment are taken into consideration. Only the hits with the highest score are reported within overlapping regions. Domains are subsequently annotated to a repeat class which they come from according to our classification system.
External visualization tool Jbrowse has been employed to interactively visualize all output features for all input sequences.  

**OUTPUTS** 

	- table reporting hits/copy numbers at every position for all repeats occuring in the sequence
	- GFF file reporting N regions in the sequence
	- GFF file reporting repetitive regions of a certain length and above copy numbers/hits threshold
	- GFF file reporting protein domains, classification of domain, chain orientation and alignment sequence
	- HTML reporting domains and profiles summary visualization that can be further explored using a link to JBrowse
	

 </help>

 
</tool>

